---
lab:
    title: '15 - Azure Sentinel'
    module: 'モジュール 04 - セキュリティ操作の管理'
---

# 課題 15: Azure Sentinel
# 受講生用ラボ マニュアル

## ラボのシナリオ

Azure Sentinel ベースの脅威検出と応答の概念実証を作成するよう依頼されました。具体的には、次のことを行います。

- Azure アクティビティと Security Center からデータの収集を開始します。
- 組み込みおよびカスタム アラートを追加する 
- プレイブックを使用してインシデントへの応答を自動化する方法を確認します。

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1: Azure Sentinel の実装

## ラボ ファイル：

- **\\Allfiles\\Labs\\15\\changeincidentseverity.json**

### 演習 1: Azure Sentinel の実装

### 予想時間: 30 分

この演習では、次のタスクを行います。

- タスク 1: Azure Sentinel をオンボードにする
- タスク 2: Azure アクティビティを Sentinel に接続する
- タスク 3: Azure アクティビティ データ コネクタを使用するルールを作成します。 
- タスク 4: プレイブックを作成する
- タスク 5: カスタム アラートを作成し、自動化された応答としてプレイブックを構成します。
- タスク 6: インシデントを呼び出し、関連するアクションを確認します。

#### タスク 1: Azure Sentinel をオンボードにする

このタスクでは、Azure Sentinel にオンボードし、Log Analytics ワークスペースを接続します。 

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注意**: このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure ポータルにサインインします。

1. Azure portal で Azure portal ページの上部にある **「リソース、サービス、ドキュメントの検索」** テキスト ボックスで、**「Azure Sentinel」** と入力し、**「Enter」** キーを押します。

1. 「**Azure Sentinel**」ブレードで、「**+ 作成**」をクリックします。

1. 「**ワークスペースに Azure Sentinel を追加**」ブレードで、Azure Monitor ラボで作成した Log Analytics ワークスペースを選択し、「**追加**」をクリックします。

    >**注意**: Azure Sentinel には、ワークスペースに対して非常に具体的な要件があります。たとえば、Azure Security Center によって作成されたワークスペースは使用できません。[クイック スタート: Azure Sentinel をオンボードにする](https://docs.microsoft.com/ja-jp/azure/sentinel/quickstart-onboard)
	
#### タスク 2: Azure アクティビティ データ コネクタを使用するように Azure Sentinel を構成します。 

このタスクでは、Azure アクティビティ データ コネクタを使用するように Sentinel を構成します。  

1. Azure portal の 「**Azure Sentinel \| 概要」**」ブレードの **「構成」** セクションで 、**「データ コネクタ」** をクリックします。 

1. 「**Azure Sentinel \| データ コネクタ** ブレード、使用可能なコネクタのリストを確認し、検索バーに「**Azure**」と入力して、**Azure アクティビティ** コネクタを表すエントリを選択し (必要に応じて \<< を使用して左側のメニュー バーを非表示にします)、説明と状態を確認し、「**コネクタ ページを開く**」をクリックします。

1. **Azure アクティビティ** ブレードで「**手順**」タブを選択し、**前提条件**をメモして、「**構成**」まで下にスクロールします。コネクタの更新について説明している情報に注意してください。Azure Pass サブスクリプションは従来の接続方法を使用したことがないため、手順 1 をスキップして (「**すべて切断**」ボタンがグレー表示されます)、手順 2 に進むことができます。

1. 手順 2で、**診断設定の新しいパイプラインを介してサブスクリプションを接続し**、「Azure ポリシー割り当てウィザードを起動して手順に従います」の手順を確認し、「**Azure ポリシー割り当てウィザードを起動する\>**」をクリックします。

1. **指定した Log Analytics ワークスペースにストリーミングするように Azure アクティビティ ログを構成する** (「ポリシーの割り当て」ページ)「**基本**」タブで、「**スコープの省略形 (...)**」ボタンをクリックします。「**スコープ**」ページで、ドロップダウン サブスクリプション リストから Azure Pass サブスクリプションを選択し、ページの下部にある「**選択**」ボタンをクリックします。

    >**注**: リソース グループを選択*しないでください*。

1. 「**基本**」タブの下部にある「**次へ**」ボタンをクリックして、「**パラメーター**」タブに進みます。「**パラメーター**」ブで、「**プライマリ ログ分析ワークスペースの省略形 (...)**」ボタンをクリックします。「**プライマリ ログ分析ワークスペース**」ページで、Azure パス サブスクリプションが選択されていることを確認し、「**ワークスペース**」ドロップダウンを使用して、Sentinel に使用しているログ分析ワークスペースを選択します。完了したら、ページの下部にある「**選択**」ボタンをクリックします。

1. 「**パラメーター**」タブの下部にある「**次へ**」ボタンをクリックして、「**修復**」タブに進みます。「**修復**」タブで、「**修復タスクの作成**」チェックボックスを選択します。これにより、「**修復するポリシー**」ドロップダウンの「指定した Log Analytics ワークスペースにストリーミングするように Azure アクティビティ ログを構成する」が有効になります。「**システムによって割り当てられた ID の場所**」ドロップダウンで、Log Analytics ワークスペース用に以前に選択した地域 (たとえば、米国東部) を選択します。

1. 「**パラメーター**」タブの下部にある「**次へ**」ボタンをクリックして、「**非準拠メッセージ**」タブに進みます。  必要に応じて非準拠メッセージを入力し (これはオプションです)、「**非準拠メッセージ**」タブの下部にある「**Review + create**」ボタンをクリックします。

1. 「**作成**」ボタンをクリックします。次の 3 つの成功した状態メッセージを確認する必要があります。**ポリシー割り当ての作成が成功しました、役割割り当ての作成が成功しました、修復タスクの作成が成功しました**。

    >**注**: 通知、ベル アイコンをチェックして、3 つの成功したタスクを確認できます。

1. 「**Azure アクティビティ**」ペインに「**受信したデータ**」 グラフが表示されていることを確認します（ブラウザ ページを更新する必要がある場合があります）。  

    >**注**: 状態に「接続済み」と表示され、グラフに受信したデータが表示されるまで、15 分以上かかる場合があります。

#### タスク 3: Azure アクティビティ データ コネクタを使用するルールを作成します。 

このタスクでは、Azure アクティビティ データ コネクタを使用するルールを確認し、作成します。 

1. 「**Azure Sentinel \| 構成**」ブレードで、「**分析**」をクリックします。 

1. 「**Azure Sentinel \| **「**分析**」ブレードで、「**ルール テンプレート**」タブをクリックします。 

    >**注**: 作成できるルールの種類を確認します。各ルールは、特定のデータ ソースに関連付けられます。

1. ルール テンプレートの一覧で、検索バーフォームに「**不審**」と入力し、**Azure アクティビティ** データソースに関連付けられている「**不審なリソースの作成またはデプロイの数**」エントリをクリックします。次に、ルール テンプレートのプロパティを表示している」で、「**ルールの作成**」をクリックします（必要であればページの右側にスクロールする）。

    >**注**: このルールの重大度は中程度です。 

1. 「**分析ルール ウィザード - テンプレートからの新しいルールの作成**」ブレードの「**全般**」タブで、既定の設定をそのまま使用し、「**次: ルール ロジックを設定 >**」をクリックします。

1. 「**分析ルール ウィザード - テンプレートからの新しいルールの作成**」ブレードの「**ルールのロジックを設定**」タブで、既定の設定をそのまま使用し、「**次: インシデントの設定 >**」 をクリックします。

1. 「**分析ルール ウィザード - テンプレートからの新しいルールの作成**」ブレードの「**インシデント設定**」タブで、既定の設定をそのまま使用し、「**次: 自動応答 >**」 をクリックします。 

    >**注**: この機能を使用すると、ロジック アプリとして実装されたプレイブックをルールに追加して、問題の修復を自動化できます。

1. 「**分析ルール ウィザード - テンプレートからの新しいルールの作成**」ブレードの「**自動応答**」タブで、既定の設定をそのまま使用し、「**次: レビュー >**」 をクリックします。 

1. 「**分析ルール ウィザード - テンプレートからの新しいルールの作成する**」ブレードの「**確認と作成**」タブで、「**作成**」をクリックします。

    >**注**: これで、アクティブなルールが作成されました。

#### タスク 4: プレイブックを作成する

このタスクでは、プレイブックを作成します。セキュリティ プレイブックは、アラートに応答して Azure Sentinel によって呼び出すことができるタスクのコレクションです。 

1. Azure portal で Azure portal ページの上部にある **「リソース、サービス、ドキュメントの検索」** テキスト ボックスで、**「カスタムテンプレートのデプロイ」** と入力し、**「Enter」** キーを押します。

1. **カスタム デプロイ** ブレードで、**エディターで独自のテンプレートを作成する** のオプションをクリックします。

1. **「テンプレートの編集」** ブレードで、**「ファイルの読み込み」** をクリックし、**\\Allfiles\\Labs\\15\\changeincidentseverity.json** ファイルを見つけて、**「開く」** をクリックします。

    >**注意**: サンプル プレイブックは、[https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks](https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks) にあります。

1. **「テンプレートの編集」** ブレードで、**「保存」** をクリックします。

1. **「カスタム デプロイ」** ブレードで、次の設定が構成されていることを確認します (既定値を使用して他の設定を行います)。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
    |リソース グループ|**AZ500Lab131415**|
    |リージョン|**米国東部**|
    |プレイブックの名前|**Change-Incident-Severity**|
    |ユーザー名|ご使用のメール アドレス|

1. **「確認と作成」** をクリックし、**「作成」** をクリックします。

    >**注意**: デプロイが完了するのを待ちます。

1. Azure portal の、Azure portal ページの上部にある **「ソース、サービス、ドキュメントの検索」** テキスト ボックスで、 **「リソース グループ」**と入力し、**「Enter」** キーを押します。

1. 「**リソース グループ**」 ブレードのリソース グループの一覧で、「**AZ500Lab131415**」 エントリをクリックします。

1. **「AZ500Lab131415」** リソース グループ ブレードのリソースの一覧で、新しく作成された **Change-Incident-Severity** ロジック アプリを表すエントリをクリックします。

1. **「Change-Incident-Severity」** ブレードで、**「編集」** をクリックします。

    >**注意**: **「Logic Apps デザイナー」** ブレードでは、4 つの接続のそれぞれに警告が表示されます。これは、それぞれが確認し設定する必要があることを意味します。

1. **「Logic Apps デザイナー」** ブレードで、最初の **「接続」** 手順をクリックします。

1. **「新規追加」** をクリックし、**「テナント」** ドロップダウン リストのエントリに Azure ADテナント名が含まれていることを確認し、**「サインイン」** をクリックします。

1. プロンプトが表示された場合は、このラボで使用する Azure サブスクリプションの所有者または共同作成者のロールを使用したユーザー アカウントでログインします。

1. 2 つ目の「**接続**」手順をクリックし、 接続の一覧で、前の手順で作成した接続を表す 2 つ目のエントリを選択します。

1. 残りの 2 つの「**接続**」手順についても、前の手順を繰り返します。

    >**注**: いずれの手順にも警告が表示されていないことを確認します。

1. 「**Logic Apps デザイナー**」ブレードで、「**保存**」をクリックして変更を保存します。

#### タスク 5: カスタム アラートを作成し、自動化された応答としてプレイブックを構成する

1. Azure portal で、**Azure Sentinel** に移動します。

1. 「**Azure Sentinel \| 概要**」ブレードの **「構成」** セクションで 、**「分析」** をクリックします。

1. 「**Azure Sentinel \| 分析**」ブレードで **「+ 作成」** をクリックし、ドロップダウン メニューの **「スケジュール済みクエリ ルール」** をクリックします。 

1. **「分析ルール ウィザード - 新しいルールの作成」** ブレードの **「全般」** タブで、次の設定を指定します (既定値を他のユーザーのままにします)。

    |設定|値|
    |---|---|
    |名前|**Playbook Demo**|
    |方針|**Initial Access**|

1. 「**次:ルールのロジックを設定 >**」 をクリックします。

1. **「分析ルール ウィザード - scheduled ルールの作成」** ブレードの **「ルールのロジックを設定」** タブ で、**「ルールのクエリ」** テキスト ボックスに次のルール クエリを貼り付けます。 

    ```
    AzureActivity
     | where ResourceProviderValue =~ "Microsoft.Security" 
     | where OperationNameValue =~ "Microsoft.Security/locations/jitNetworkAccessPolicies/delete" 
    ```

    >**注意**: このルールは、Just In Time VM アクセス ポリシーの削除を識別します。

    >**注**: 解析エラーが発生した場合、IntelliSense がクエリに値を追加している可能性があります。クエリが一致していることを確認し、それ以外の場合は、クエリをメモ帳に貼り付け、メモ帳からルール クエリに貼り付けます。 


1. **「分析ルール ウィザード - 新しいルールの作成」** ブレードの **「ルール ロジックの設定」** タブ の **「クエリのスケジュール設定」** セクションで、**「クエリの実行間隔」** を **「5 分」** に設定します。

1. **「分析ルール ウィザード - 新しいルールの作成」** ブレードの **「ルール ロジックの設定」** タブで 、残りの設定の既定値をそのまま使用し、**「次:インシデントの設定 >」** をクリックします。

1. **「分析ルール ウィザード - 新しいルールの作成」** ブレードの **「インシデント設定」** タブで、既定の設定をそのまま使用し、**「次:自動応答 >」** をクリックします。 

1. 「**分析ルール ウィザード - 新しいルールの作成**」の「**自動応答**」タブで、「**アラートの自動化**」ドロップダウン リストで「**Change-Incident-Severity**」エントリの横のチェックボックスを選択して、「**次: レビュー >**」をクリックします。 

1. **「分析ルール ウィザード - 新しいルールの作成」** ブレードの **「確認と作成」** タブで、**「作成」** をクリックします。

    >**注意**: これで、**Playbook Demo**と呼ばれる新しいアクティブなルールが作成されます。rue ロジックによって識別されたイベントが発生すると、中程度の重大度アラートが発生し、対応するインシデントが生成されます。

#### タスク 6: インシデントを呼び出し、関連するアクションを確認します。

1. Azure portal で、**セキュリティ センター** に移動します。

    >**注意**: セキュア スコアを確認してください。すでに更新されているはずです。 

1. 「**セキュリティ センター \| Azure Defender**」 ブレードで、「高度な保護」項目の「**Just-In-Time VM アクセス**」 セクションをクリックします。

1. 「**Just-In-Time VM アクセス**」 ブレードで 、**myVM** 仮想マシンを参照する行の右側で、**「省略」** ボタンをクリックし、**「削除」** をクリックし、**「はい」** をクリックします。

1. Azure portal で、Azure portal ページの上部にある **「リソース、サービス、ドキュメントの検索」** テキスト ボックスで、**「アクティビティ ログ」** を入力し、**「Enter」** キーを押します。

1. 「**アクティビティ ログ**」ブレードに移動し、「**Delete JIT Network Access Policies**」エントリをメモします。 

    >**注意**: 表示されるまでに数分かかることがあります。 

1. Azure portal で、**Azure Sentinel** に移動します。

1. 「**Azure Sentinel \| 概要**」ブレードでダッシュボードを確認し、Just In Time VM アクセス ポリシーの削除に対応するアラートが表示されることを確認します。

    >**注意**: アラートが **Azure Sentinel \| 概要」** ブレードに表示されるまでに最大 10 分かかる場合があります。 その時点でアラートが表示されない場合は、前のタスクで参照されているクエリ ルールを実行して、Just In Time アクセス ポリシーの削除アクティビティが、Azure Sentinel インスタンスに関連付けられた Log Analytics ワークスペースに伝達されていることを確認します。それ以下の場合は、Just in time VM アクセス ポリシーを再作成し、もう一度削除します。

1. 「**Azure Sentinel \| 概要」** ブレードの 「**脅威管理**」 セクションで、「**インシデント**」 をクリックします。

1. ブレードに中程度または高い重大度レベルのインシデントが表示されることを確認します。

    >**注**: インシデントが「**Azure Sentinel \| インシデント**」ブレードに表示されるまでに最大10分かかる場合があります。 

    >**注**: **構成** エントリの「**オートメーション**」ブレードの「**プレイブック**」タブを確認します。成功した実行と失敗した実行の数がわかります。

    >**注**: インシデントに別の重大度レベルとステータスを割り当てるオプションがあります。

> 結果: Azure Sentinel ワークスペースを作成し、Azure アクティビティ ログに接続し、ジャスト イン タイム VM アクセス ポリシーの削除に応答してトリガーされるプレイブックとカスタム アラートを作成し、構成が有効であることを確認しました。

**リソースをクリーン アップする**

> 新しく作成した Azure リソースのうち、使用しないリソースは必ず削除してください。使用していないリソースを削除することで、予期しないコストが発生しなくなります。 

1. Azure portal から、Azure portal の右上にあるアイコンをクリックして、 Cloud Shell を開きます。メッセージが表示されたら、「**PowerShell**」 と 「**ストレージの作成**」 をクリックします。

1. 「Cloud Shell」 ウィンドウの左上隅にあるドロップダウン メニューで 「**PowerShell**」 が選択されていることを確認します。

1. 「クラウド シェル」 ウィンドウ内の 「PowerShell」 セッションで、次の手順を実行して、このラボで作成したリソース グループを削除します。
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB131415" -Force -AsJob
    ```
1. **「Cloud Shell」** ウィンドウを閉じます。
