---
lab:
    title: '07 - ネットワーク セキュリティ グループとアプリケーション セキュリティ グループ'
    module: 'モジュール 02 - プラットフォーム保護の実装'
---

# 課題 07: ネットワーク セキュリティ グループとアプリケーション セキュリティ グループ
# 受講生用ラボ マニュアル

## ラボのシナリオ

組織の仮想ネットワーク インフラストラクチャを実装し、正しく動作していることを確認するためのテストを依頼されました。特に以下の点に注意します。

- 組織には、Web サーバーと管理サーバーサーバー の 2 グループがあります。
- サーバーの各グループは、独自のアプリケーション セキュリティ グループに含める必要があります。 
- 管理サーバーに RDP を実行することはできますが、Web サーバーには RDP を実行することはできません。
- インターネットからアクセスすると、Web サーバーに IIS Web ページが表示されます。 
- ネットワーク セキュリティ グループの規則を使用して、ネットワーク アクセスを制御する必要があります。 

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います:

- 演習 1: 仮想ネットワーク インフラストラクチャを作成する
- 演習 2: 仮想マシンを展開し、ネットワーク フィルターをテストする

### 演習 1: 仮想ネットワーク インフラストラクチャを作成する

### 予想時間: 20 分

> このラボのすべてのリソースに対して、**米国東部** リージョンを使用しています。クラスで使用する地域であることを講師に確認します。 

この演習では、次のタスクを行います。

- タスク 1: 1 つのサブネットがある仮想ネットワークを作成します。
- タスク 2: 2 つのアプリケーションのセキュリティ グループを作成します。
- タスク 3: ネットワーク セキュリティ グループを作成し、仮想ネットワーク サブネットに関連付けます。
- タスク 4: Web サーバーへのすべてのトラフィックに対するインバウンド NSG セキュリティ ルールを作成し、管理サーバーへ RDP します。

#### タスク 1:  仮想ネットワークを作成する

このタスクでは、ネットワークおよびアプリケーションのセキュリティ グループで使用する仮想ネットワークを作成します。 

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注意**: このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure ポータルにサインインします。

1. Azure portal の 「**参照資料、サービス、ドキュメントの検索**」 テキスト ボックスで、Azure portal ページの上部に「 **仮想ネットワーク**」と入力し、**Enter** キーを押します。

1. 「**Virtual Networks**」ブレードで、「**+ 作成**」をクリックします。

1. 「**仮想ネットワークの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定し (他の設定は既定値のままにします)、「**次:IPアドレス**」 をクリックします。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
    |リソース グループ|「**新規作成**」 をクリックし、「**AZ500Lab07**」という名前を入力する|
    |名前|**myVirtualNetwork**|
    |リージョン|**(US)米国東部**|

1. 「**仮想ネットワークの作成**」 ブレードの 「**IP アドレス**」 タブで、**IPv4 アドレス空間** を **10.0.0.0.0/16** に設定し、必要に応じて 「**サブネット名**」 列で 「**default**」 をクリックし、「**サブネットの編集**」 ブレードで次の設定を指定し、「**保存**」 をクリックします。

    |設定|値|
    |---|---|
    |サブネット名|**default**|
    |サブネット アドレス範囲|**10.0.0.0/24**|

1. 「**仮想ネットワークの作成**」 ブレードの 「**IP アドレス**」 タブに戻り、「**確認および作成**」をクリックします。

1. 「**仮想ネットワークの作成**」 ブレードの 「**確認および作成**」 タブで、「**作成**」 をクリックします。

#### タスク 2:  アプリケーション セキュリティ グループを作成する

このタスクでは、アプリケーション セキュリティ グループを作成します。

1. Azure portal で、Azure portal ページの上部にある 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスに「**アプリケーションのセキュリティ グループ**」と入力し、**Enter** キーを押します。

1. 「**アプリケーション セキュリティ グループ**」ブレードで、「**+ 作成**」をクリックします。

1. 「**アプリケーションのセキュリティ グループの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定します。 

    |設定|値|
    |---|---|
    |リソース グループ|**AZ500Lab07**|
    |名前|**myAsgWebServers**|
    |リージョン|**(US)米国東部**|

    >**注意**: このグループは Web サーバー用になります。

1. **「確認および作成」** をクリックし、**「作成」** をクリックします。

1. 「**アプリケーション セキュリティ グループ**」ブレードに戻り、「**+ 作成**」をクリックします。

1. 「**アプリケーションのセキュリティ グループの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定します。 

    |設定|値|
    |---|---|
    |リソース グループ|**AZ500Lab07**|
    |名前|**myAsgMgmtServers**|
    |リージョン|**(US)米国東部**|

    >**注意**: このグループは管理サーバー用になります。

1. **「確認および作成」** をクリックし、**「作成」** をクリックします。

#### タスク 3:  ネットワーク セキュリティ グループを作成し、NSG をサブネットに関連付けます。

このタスクでは、ネットワーク セキュリティ グループを作成します。 

1. Azure portal で、Azure ポータルの上部にある 「 **リソース、サービス、ドキュメントの検索** 」 テキスト ボックスで、 **ネットワーク セキュリティ グループ**と入力 し、**Enter** キーを押します。

1. 「**ネットワーク セキュリティ グループ**」ブレードで、「**+ 作成**」をクリックします。

1. **ネットワークセキュリティグループの作成**ブレードの**基本**タブで、次の設定を指定します。 

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
    |リソース グループ|**AZ500Lab07**|
    |名前|**myNsg**|
    |リージョン|**(US)米国東部**|

1. **「確認および作成」** をクリックし、**「作成」** をクリックします。

1. Azure portal で、「**ネットワーク セキュリティ グループ**」 ブレードに戻り、「**myNsg**」 エントリをクリックします。

1. 「**myNsg**」 ブレードの 「**設定**」 セクションで、「**サブネット**」 をクリックしてから 「**+ 関連付け**」 をクリックします。 

1. **サブネットの関連付け** ブレードで、次の設定を指定し、**OK** をクリックします。

    |設定|値|
    |---|---|
    |仮想ネットワーク|**myVirtualNetwork**|
    |サブネット|**default**|

#### タスク 4: Web サーバーへのすべてのトラフィックに対するインバウンド NSG セキュリティ ルールを作成し、管理サーバーへ RDP します。 

1. 「**myNsg**」 ブレードの 「**設定**」 セクションで、「**受信セキュリティ規則**」 をクリックします。

1. 既定の受信セキュリティ規則 を確認してから、「**+ 追加**」 を選択します。

1. 「**受信セキュリティ規則の追加**」 ブレードで、TCP ポート 80 および 443 を許可するために、**MYAsgWebServers** アプリケーション セキュリティ グループに次の設定を指定します (他の設定はすべて既定値のままにします)。 

    |設定|値|
    |---|---|
    |宛先|ドロップダウン リストで、「**Application security group**」 を選択してから、「**myAsgWebServers**」 をクリックします。|
    |宛先ポート範囲|**80,443**|
    |プロトコル|**TCP**|
    |優先度|**100**|                                                    
    |名前|**Allow-Web-All**|

1. 「**受信セキュリティ規則の追加**」 ブレードで、「**追加**」 をクリック して新しい受信規則を作成します。 

1. 「**myNsg**」 ブレードの 「**設定**」 セクションで、「**受信セキュリティ規則**」 をクリックしてから、「**+ 追加**」 をクリックします。

1. 「**受信セキュリティ規則の追加**」 ブレードで、 RDP ポート (TCP 3389) を許可するために、次の設定を **MYAsgMgmtServers** アプリケーション セキュリティ グループに指定します (他の設定はすべて既定値のままにします)。 

    |設定|値|
    |---|---|
    |宛先|ドロップダウン リストで、「**Application security group**」 を選択してから、「**myAsgMgmtServers**」 をクリックします。|
    |宛先ポート範囲|**3389**|
    |プロトコル|**TCP**|
    |優先度|**110**|                                                    
    |名前|**Allow-RDP-All**|

1. 「**受信セキュリティ規則の追加**」 ブレードで、「**追加**」 をクリック して新しい受信規則を作成します。 

> 結果: 仮想ネットワーク、受信セキュリティ規則を使用したネットワーク セキュリティ、および 2 つのアプリケーション セキュリティ グループをデプロイしました。 

### 演習 2: 仮想マシンをデプロイしネットワーク フィルターをテストする

### 予想時間: 25 分

この演習では、次のタスクを行います。

- タスク 1: Web サーバーとして使用する仮想マシンを作成します。
- タスク 2: 管理サーバーとして使用する仮想マシンを作成します。 
- タスク 3: 各仮想マシンのネットワーク インターフェイスをアプリケーション セキュリティ グループに関連付けます。
- タスク 4: ネットワーク トラフィックのフィルタリングをテストします。

#### タスク 1: Web サーバーとして使用する仮想マシンを作成します。

このタスクでは、Web サーバーとして使用する仮想マシンを作成します。

1. Azure portal の 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスで、Azure portal ページの上部に「**Virtual Machines**」と入力し、**Enter** キーを押します。

1. 「**仮想マシン**」ブレードで、「**+追加**」をクリックし、ドロップダウンリストで「**+ 仮想マシン**」をクリックします。

1. 「**仮想マシンの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定します (既定値を他のユーザーのままにします)。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
   |リソース グループ|**AZ500Lab07**|
   |仮想マシン名|**myVmWeb**|
   |リージョン|**(US) 米国東部**|
   |イメージ|**Windows Server 2019 Datacenter - Gen 2**|
   |サイズ|**Standard D2s v3**|
   |ユーザー名|**student**|
   |パスワード|**Pa55w.rd1234**|
   |パブリック受信ポート|**なし**|
   |既存の Windows Server ライセンスを使用しますか?|**いいえ**|

    >**注意**: 公開の受信ポートの場合、事前に作成された NSG に依存します。 

1. 「**次:ディスク**」 をクリックします。「**仮想マシンの作成**」 ブレードの 「**ディスク**」 タブで、「**OS ディスクの種類**」 を 「**Standard HDD**」 に設定し、「**次:ネットワーク**」 をクリックします。

1. 「**仮想マシンの作成**」 ブレードの 「**ネットワーク**」 タブで、以前に作成したネットワーク **myVirtualNetwork** を選択します。

1. 「**NIC ネットワーク セキュリティ グループ**」 で 「**なし**」 を選択します。

1. 「**次へ: 管理 >**」を「**仮想マシンの作成**」ブレードの「**管理**」タブでクリックし、次の設定を確認します。

   |設定|値|
   |---|---|
   |ブート診断|**マネージド ストレージ アカウントで有効にする（推奨）**|

1. 「**仮想マシンの作成**」 ブレードで 「**確認および作成**」 をクリックし、検証が成功したことを確認して、「**作成**」 をクリックします。

#### タスク 2: 管理サーバーとして使用する仮想マシンを作成します。 

このタスクでは、管理サーバーとして使用する仮想マシンを作成します。

1. Azure portal で、「**仮想マシン**」ブレードに戻り、「**+ 作成**」をクリックし、ドロップダウンリストで「**+ 仮想マシン**」をクリックします。

1. 「**仮想マシンの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定します (既定値を他のユーザーのままにします)。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
   |リソース グループ|**AZ500Lab07**|
   |仮想マシン名|**myVMMgmt**|
   |リージョン|(US) 米国東部|
   |イメージ|**Windows Server 2019 Datacenter - Gen 2**|
   |サイズ|**Standard D2s v3**|
   |ユーザー名|**student**|
   |パスワード|**Pa55w.rd1234**|
   |パブリック受信ポート|**なし**|
   |既存の Windows Server ライセンスを使用しますか?|**いいえ**|

    >**注意**: 公開の受信ポートの場合、事前に作成された NSG に依存します。 

1. 「**次:ディスク**」 をクリックします。「**仮想マシンの作成**」 ブレードの 「**ディスク**」 タブで、「**OS ディスクの種類**」 を 「**Standard HDD**」 に設定し、「**次:ネットワーク**」 をクリックします。

1. 「**仮想マシンの作成**」 ブレードの 「**ネットワーク**」 タブで、以前に作成したネットワーク **myVirtualNetwork** を選択します。

1. 「**NIC ネットワーク セキュリティ グループ**」 で 「**なし**」 を選択します。

1. 「**次:管理 >**」 をクリックします。「**仮想マシンの作成**」 ブレードの 「**管理**」 タブで、次の設定を指定します。

   |設定|値|
   |---|---|
   |ブート診断|**マネージド ストレージ アカウントで有効にする（推奨）**|

1. 「**仮想マシンの作成**」 ブレードで 「**確認および作成**」 をクリックし、検証が成功したことを確認して、「**作成**」 をクリックします。

    >**注意**: 続行する前に、仮想マシンがデプロイされるのを待ちます。 

#### タスク 3: 各仮想マシンのネットワーク インターフェイスをアプリケーション セキュリティ グループに関連付けます。

このタスクでは、各仮想マシンのネットワーク インターフェイスを対応するアプリケーション セキュリティ グループに関連付けます。myVMWeb 仮想マシン インターフェイスは、myAsgWebServers ASG に関連付けられます。myVMMgmt 仮想マシン インターフェイスは、myAsgMgmtServers ASG に関連付けられます。 

1. Azure portal で、「**Virtual Machines**」 ブレードに戻り、両方の仮想マシンが 「**実行中**」 状態で一覧表示されていることを確認します。

1. 仮想マシンの一覧で、「**myVMWeb**」 エントリをクリックします。

1. 「**myVMWeb**」 ブレードの 「**設定**」 セクションで、「**ネットワーク**」 をクリックし、次に 「**myVMWeb \| ネットワーク**」 ブレードで、「**アプリケーションのセキュリティ グループ**」 タブをクリックします。

1. 「**アプリケーションのセキュリティ グループを構成**」 クリックし、**「アプリケーションのセキュリティグループ**」 ドロップダウン リストの 「**myAsgWebServers**」 を選択してから、「**保存**」 をクリックします。

1. 「**Virtual Machines**」 ブレードに戻り、仮想マシンの一覧で、「**myVMMgmt**」 エントリをクリックします。

1. 「**myVMMgmt**」 ブレードの 「**設定**」 セクションで、「**ネットワーク**」 をクリックし、次に 「**myVMMgmt \| ネットワーク**」 ブレードで、「**アプリケーションのセキュリティ グループ**」 タブをクリックします。

1. 「**アプリケーションのセキュリティ グループを構成**」 をクリックし、「**アプリケーションのセキュリティ グループ**」 ドロップダウン リストで 「**myAsgMgmtServers**」 を選択してから、「**保存**」 をクリックします。

#### タスク 4: ネットワーク トラフィックのフィルタリングをテストする

このタスクでは、ネット-ワーク トラフィック フィルターをテストします。myVMMgmnt 仮想マシンに RDP できるはずです。インターネットから myVMWeb 仮想マシンに接続し、既定の IIS Web ページを表示できるはずです。  

1. 「**myVMMgmt**」 仮想マシン ブレードに戻ります。

1. 「**myVMMgmt**」 ブレードで 「**接続**」 をクリックし、ドロップダウン メニューの 「**RDP**」 をクリックします。 

1. 「**RDP ファイルのダウンロード**」 をクリックし、リモート デスクトップ経由で **myVMMgmt** Azure VM に接続するために使用します。認証を求められたら、次の資格情報を入力します。

   |設定|値|
   |---|---|
   |ユーザー名|**student**|
   |パスワード|**Pa55w.rd1234**|

    >**注意**: リモート デスクトップ接続が正常に完了したことを確認します。この時点で、リモート デスクトップから myVMMgmt に接続できることを確認しました。

1. Azure portal で、「**myVMWeb**」 仮想マシン ブレードに移動します。

1. 「**myVMWeb**」 ブレードの 「**操作**」 セクションで、「**実行コマンド**」 をクリックしてから、「**RunPowerShellScript**」 をクリックします。

1. 「**コマンド スクリプトの実行**」 ウィンドウで、次のコマンドを実行して、Web サーバーのロールを **myVmWeb** にインストールします。

    ```powershell
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    ```

    >**注意**: インストールが完了するまで待ちます。これには数分間かかることがあります。その時点で、HTTP/HTTPS 経由で myVMWeb にアクセスできることを確認できます。

1. Azure portal で、「**myVMWeb**」 ブレードに戻ります。

1. 「**myVMWeb**」 ブレードで、myVmWeb Azure VM の**パブリック IP** アドレスを特定します。

1. 別のブラウザー タブを開き、前の手順で特定した IP アドレスに移動します。

    >**注意**: ポート 80 が、**myAsgWebServers** アプリケーション セキュリティ グループの設定に基づいてインターネットからの受信を許可されるため、ブラウザー ページには既定の IIS ウェルカム ページが表示されるはずです。myVMWeb Azure VM のネットワーク インターフェイスは、そのアプリケーション セキュリティ グループに関連付けられます。 

> 結果: NSG および ASG の設定が機能しており、トラフィックが正しく管理されていることを確認しました。 

**リソースをクリーン アップします**

> Azure リソースのうち、使用しないリソースは必ず削除してください。使用していないリソースを削除することで、予期しないコストが発生しなくなります。 

1. Azure portal の右上にある最初のアイコンをクリックして、Cloud Shell を開きます。メッセージが表示されたら、「**PowerShell**」 と 「**ストレージの作成**」 を選択します。

1. 「Cloud Shell」 ウィンドウの左上隅にあるドロップダウン メニューで 「**PowerShell**」 が選択されていることを確認します。

1. 「クラウド シェル」 ウィンドウ内の 「PowerShell」 セッションで、次の手順を実行して、このラボで作成したリソース グループを削除します。
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB07" -Force -AsJob
    ```

1.  **「Cloud Shell」** ウィンドウを閉じます。 
